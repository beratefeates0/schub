<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>School Bus Detection System</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: black;
            font-family: Arial, Helvetica, sans-serif;
            overflow: hidden;
        }

        video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
        }

        /* Status box ‚Äì RIGHT BOTTOM */
        #statusBox {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .bus {
            color: #ff3b3b;
            border: 2px solid #ff3b3b !important;
        }

        .nobus {
            color: #4caf50;
        }

        /* Legal warning ‚Äì LEFT BOTTOM */
        #legal {
            position: fixed;
            bottom: 20px;
            left: 20px;
            max-width: 380px;
            background: rgba(0, 0, 0, 0.65);
            color: #ddd;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            z-index: 10;
        }
    </style>
</head>

<body>

<video id="video" autoplay playsinline></video>

<div id="statusBox" class="nobus">
    ‚úîÔ∏è No school bus detected
</div>

<div id="legal">
    ‚ö†Ô∏è <strong>Safety Notice:</strong><br>
    This system is a driver assistance tool only.  
    The driver must always remain fully attentive to the road. 
    Do not rely solely on this system while driving.
</div>

<script>
    const video = document.getElementById("video");
    const statusBox = document.getElementById("statusBox");

    // Dynamic URL for Render
    const SERVER_URL = window.location.origin + "/detect";
    const beep = new Audio("/beep.m4a");
    beep.loop = true;

    let busDetected = false;

    // Use environment camera (back camera) for mobile devices
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
        } 
    })
    .then(stream => {
        video.srcObject = stream;
    })
    .catch(err => {
        console.error(err);
        statusBox.textContent = "‚ùå Camera access denied";
    });

    function captureFrameAndSend() {
        if (video.videoWidth === 0) return;

        // Canvas matches video's original full resolution
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append("file", blob, "frame.jpg");

            try {
                const response = await fetch(SERVER_URL, {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();

                if (result.bus) {
                    if (!busDetected) {
                        // Browser requires user interaction to play audio
                        beep.play().catch(err => console.log("Waiting for user interaction for audio."));
                    }
                    busDetected = true;
                    statusBox.textContent = "üö® Potential School Bus";
                    statusBox.className = "bus";
                } else {
                    if (busDetected) {
                        beep.pause();
                        beep.currentTime = 0;
                    }
                    busDetected = false;
                    statusBox.textContent = "‚úîÔ∏è No school bus detected";
                    statusBox.className = "nobus";
                }

            } catch (err) {
                console.error(err);
                statusBox.textContent = "‚ùå Server connection error";
            }
        }, "image/jpeg", 0.9); // High quality
    }

    // Capture and send frame every 2 seconds
    setInterval(captureFrameAndSend, 2000);

    // Initial click listener to enable audio on mobile browsers
    document.body.addEventListener('click', () => {
        console.log("Audio ready");
    }, { once: true });
</script>

</body>
</html>